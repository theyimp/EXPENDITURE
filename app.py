# -*- coding: utf-8 -*-
"""
Expense Tracker (Pa Nuan Style)
‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢
"""

import json
import os
from datetime import datetime
from typing import List, Dict, Optional

class ExpenseTracker:
    def __init__(self, db_file: str = "expenses.json"):
        self.db_file = db_file
        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Category Structure)
        self.categories: Dict[str, List[str]] = {
            "‡∏≠‡∏≤‡∏´‡∏≤‡∏£": ["‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤", "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô", "‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü/‡∏Ç‡∏ô‡∏°", "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå"],
            "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á": ["‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô/‡∏à‡∏≠‡∏î‡∏£‡∏ñ", "‡∏£‡∏ñ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞", "‡∏ß‡∏¥‡∏ô/‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà/Grab", "‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á/‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"],
            "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ": ["‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"],
            "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á": ["‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á", "Gadget/‡πÑ‡∏≠‡∏ó‡∏µ", "‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô/‡∏Ç‡∏≠‡∏á‡∏™‡∏∞‡∏™‡∏°"],
            "‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": ["‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ", "Subscriptions"],
            "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û": ["‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤/‡∏´‡∏≤‡∏´‡∏°‡∏≠", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏ó‡∏≥‡∏ü‡∏±‡∏ô"],
            "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": ["‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç/‡∏ö‡∏£‡∏¥‡∏à‡∏≤‡∏Ñ", "‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏±‡∏á‡∏Ñ‡∏°", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]
        }
        self.load_data()

    def load_data(self):
        """‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"""
        if os.path.exists(self.db_file):
            with open(self.db_file, 'r', encoding='utf-8') as f:
                self.records = json.load(f)
        else:
            self.records = []

    def save_data(self):
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå JSON"""
        with open(self.db_file, 'w', encoding='utf-8') as f:
            json.dump(self.records, f, ensure_ascii=False, indent=4)
        print(f"üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á {self.db_file} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")

    def get_main_categories(self) -> List[str]:
        """‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å"""
        return list(self.categories.keys())

    def get_sub_categories(self, main_category: str) -> List[str]:
        """‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"""
        return self.categories.get(main_category, [])

    def add_expense(self, amount: float, main_cat: str, sub_cat: str, note: str = ""):
        """‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà"""
        if main_cat not in self.categories:
            raise ValueError(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å: {main_cat}")
        
        if sub_cat not in self.categories[main_cat]:
            raise ValueError(f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢: {sub_cat} ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î {main_cat}")

        record = {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "amount": amount,
            "category": main_cat,
            "subcategory": sub_cat,
            "note": note
        }
        self.records.append(record)
        self.save_data()
        print(f"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: {main_cat} ({sub_cat}) - {amount:,.2f} ‡∏ö‡∏≤‡∏ó")

    def show_summary(self):
        """‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"""
        summary = {}
        total = 0
        for item in self.records:
            cat = item['category']
            amt = item['amount']
            summary[cat] = summary.get(cat, 0) + amt
            total += amt
        
        print("\n--- üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ---")
        for cat, amt in summary.items():
            print(f"{cat}: {amt:,.2f} ‡∏ö‡∏≤‡∏ó")
        print("-" * 25)
        print(f"üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: {total:,.2f} ‡∏ö‡∏≤‡∏ó\n")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Main Execution) ---
if __name__ == "__main__":
    app = ExpenseTracker()
    
    # ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Demo Usage)
    print("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ---")
    
    # 1. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    print("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ:", app.get_main_categories())
    
    try:
        # 2. ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≥‡∏•‡∏≠‡∏á User ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        app.add_expense(500, "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏±‡πä‡∏°‡∏õ‡∏≤‡∏Å‡∏ã‡∏≠‡∏¢")
        app.add_expense(60, "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà")
        app.add_expense(1200, "‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°")
        
        # 3. ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö Error Handling)
        # app.add_expense(100, "‡∏´‡∏°‡∏ß‡∏î‡∏°‡∏±‡πà‡∏ß‡πÜ", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á") 
        
        # 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ
        app.show_summary()

    except ValueError as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
